
> æˆ‘æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒåŠ¨æ€ä»£ç†æ˜¯ç¼–è¯‘è¿˜æ˜¯è¿è¡Œæ˜¯å‘ç”Ÿçš„ï¼Ÿ

â— ğŸ¯ åŠ¨æ€ä»£ç† VS MapStruct å¯¹æ¯”

  ğŸ“‹ åŠ¨æ€ä»£ç†ï¼šè¿è¡Œæ—¶å‘ç”Ÿ

  // JDKåŠ¨æ€ä»£ç† - è¿è¡Œæ—¶åˆ›å»º
  public class UserServiceProxy {
      public static void main(String[] args) {
          UserService target = new UserServiceImpl();

          // ğŸ‘‡ è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡
          UserService proxy = (UserService) Proxy.newProxyInstance(
              target.getClass().getClassLoader(),
              target.getClass().getInterfaces(),
              new InvocationHandler() {
                  @Override
                  public Object invoke(Object proxy, Method method, Object[] args) {
                      System.out.println("æ–¹æ³•æ‰§è¡Œå‰...");
                      Object result = method.invoke(target, args); // åå°„è°ƒç”¨
                      System.out.println("æ–¹æ³•æ‰§è¡Œå...");
                      return result;
                  }
              }
          );

          proxy.saveUser(new User()); // è¿è¡Œæ—¶é€šè¿‡åå°„æ‰§è¡Œ
      }
  }

  ğŸ”„ è¿è¡Œæ—¶æµç¨‹

  ç¨‹åºå¯åŠ¨ â†’ JVMåŠ è½½ç±» â†’ è°ƒç”¨Proxy.newProxyInstance()
  â†’ JVMåŠ¨æ€ç”Ÿæˆå­—èŠ‚ç  â†’ åˆ›å»ºä»£ç†ç±»å®ä¾‹ â†’ é€šè¿‡åå°„è°ƒç”¨ç›®æ ‡æ–¹æ³•

  âš¡ MapStructï¼šç¼–è¯‘æ—¶å‘ç”Ÿ

  // MapStruct - ç¼–è¯‘æ—¶ç”Ÿæˆ
  @Mapper
  public interface ConfigConvert {
      ConfigConvert INSTANCE = Mappers.getMapper(ConfigConvert.class);
      ConfigRespVO convert(ConfigDO bean);
  }

  // ç¼–è¯‘æ—¶è‡ªåŠ¨ç”Ÿæˆï¼ˆä½ çœ‹ä¸åˆ°æºç ï¼Œä½†å­˜åœ¨äºtargetç›®å½•ï¼‰
  public class ConfigConvertImpl implements ConfigConvert {
      @Override
      public ConfigRespVO convert(ConfigDO bean) {
          // ğŸ‘‡ ç›´æ¥çš„æ–¹æ³•è°ƒç”¨ï¼Œæ— åå°„
          ConfigRespVO target = new ConfigRespVO();
          target.setId(bean.getId());
          target.setName(bean.getName());
          return target;
      }
  }

  ğŸ”§ ç¼–è¯‘æ—¶æµç¨‹

  å†™ä»£ç  â†’ Maven/Gradleç¼–è¯‘ â†’ MapStructå¤„ç†å™¨æ‰«æ@Mapper
  â†’ ç”Ÿæˆå…·ä½“å®ç°ç±» â†’ ç¼–è¯‘æˆå­—èŠ‚ç  â†’ è¿è¡Œæ—¶ç›´æ¥ä½¿ç”¨

  ğŸ“Š è¯¦ç»†å¯¹æ¯”

  | ç‰¹æ€§   | åŠ¨æ€ä»£ç†     | MapStruct |
  |------|----------|-----------|
  | å‘ç”Ÿæ—¶æœº | ğŸ”´ è¿è¡Œæ—¶   | ğŸŸ¢ ç¼–è¯‘æ—¶    |
  | æ€§èƒ½   | æ…¢ï¼ˆåå°„è°ƒç”¨ï¼‰  | å¿«ï¼ˆç›´æ¥è°ƒç”¨ï¼‰   |
  | å†…å­˜å ç”¨ | é«˜ï¼ˆåå°„å¯¹è±¡ï¼‰  | ä½ï¼ˆæ™®é€šå¯¹è±¡ï¼‰   |
  | è°ƒè¯•éš¾åº¦ | å›°éš¾ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ | å®¹æ˜“ï¼ˆæœ‰å…·ä½“ç±»ï¼‰  |
  | ç±»å‹å®‰å…¨ | è¿è¡Œæ—¶æ£€æŸ¥    | ç¼–è¯‘æ—¶æ£€æŸ¥     |
  | é”™è¯¯å‘ç° | è¿è¡Œæ—¶      | ç¼–è¯‘æ—¶       |

  ğŸ” å®é™…éªŒè¯

  åŠ¨æ€ä»£ç†çš„è¿è¡Œæ—¶ç‰¹å¾ï¼š

  // è¿è¡Œæ—¶æ‰èƒ½çœ‹åˆ°ä»£ç†ç±»çš„çœŸå®ç±»å
  Object proxy = Proxy.newProxyInstance(...);
  System.out.println(proxy.getClass().getName());
  // è¾“å‡ºï¼šcom.sun.proxy.$Proxy0 ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆçš„ç±»åï¼‰

  MapStructçš„ç¼–è¯‘æ—¶ç‰¹å¾ï¼š

  // ç¼–è¯‘åå¯ä»¥åœ¨targetç›®å½•æ‰¾åˆ°ç”Ÿæˆçš„ç±»
  // target/generated-sources/annotations/your/package/ConfigConvertImpl.class

  ConfigConvert converter = ConfigConvert.INSTANCE;
  System.out.println(converter.getClass().getName());
  // è¾“å‡ºï¼šyour.package.ConfigConvertImpl ï¼ˆç¼–è¯‘æ—¶ç”Ÿæˆçš„å›ºå®šç±»åï¼‰

  ğŸ¯ ä¸ºä»€ä¹ˆMapStructé€‰æ‹©ç¼–è¯‘æ—¶ï¼Ÿ

  1. æ€§èƒ½ä¼˜åŠ¿

  // åŠ¨æ€ä»£ç†ï¼šæ¯æ¬¡è°ƒç”¨éƒ½è¦åå°„
  method.invoke(target, args);  // æ…¢

  // MapStructï¼šç›´æ¥æ–¹æ³•è°ƒç”¨
  target.setName(source.getName());  // å¿«

  2. ç±»å‹å®‰å…¨

  // åŠ¨æ€ä»£ç†ï¼šè¿è¡Œæ—¶æ‰çŸ¥é“é”™è¯¯
  proxy.nonExistMethod();  // ç¼–è¯‘é€šè¿‡ï¼Œè¿è¡Œæ—¶æŠ¥é”™

  // MapStructï¼šç¼–è¯‘æ—¶æ£€æŸ¥
  convert(wrongTypeObject);  // ç¼–è¯‘æ—¶å°±æŠ¥é”™

  3. è°ƒè¯•å‹å¥½

  // åŠ¨æ€ä»£ç†ï¼šè°ƒè¯•çœ‹åˆ°çš„æ˜¯Proxy$0ï¼Œéš¾ä»¥ç†è§£
  // MapStructï¼šè°ƒè¯•çœ‹åˆ°çš„æ˜¯å…·ä½“çš„å®ç°ä»£ç ï¼Œæ¸…æ™°æ˜äº†

  ğŸš€ å…¶ä»–ç¼–è¯‘æ—¶ VS è¿è¡Œæ—¶çš„ä¾‹å­

  ç¼–è¯‘æ—¶å¤„ç†ï¼š

  - Lombok: @Data â†’ ç¼–è¯‘æ—¶ç”Ÿæˆgetter/setter
  - MapStruct: @Mapper â†’ ç¼–è¯‘æ—¶ç”Ÿæˆè½¬æ¢å™¨
  - QueryDSL: ç¼–è¯‘æ—¶ç”ŸæˆæŸ¥è¯¢ç±»
  - æ³¨è§£å¤„ç†å™¨: ç¼–è¯‘æ—¶å¤„ç†æ³¨è§£

  è¿è¡Œæ—¶å¤„ç†ï¼š

  - Spring AOP: è¿è¡Œæ—¶åˆ›å»ºä»£ç†
  - JDKåŠ¨æ€ä»£ç†: è¿è¡Œæ—¶ç”Ÿæˆä»£ç†ç±»
  - CGLIBä»£ç†: è¿è¡Œæ—¶ç”Ÿæˆå­ç±»
  - åå°„: è¿è¡Œæ—¶è®¿é—®ç±»ä¿¡æ¯

  ğŸ’¡ æ€»ç»“

  åŠ¨æ€ä»£ç† = è¿è¡Œæ—¶ â°
  - JVMè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç 
  - é€šè¿‡åå°„è°ƒç”¨ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒä½
  - çµæ´»æ€§é«˜ï¼Œå¯ä»¥å¤„ç†ä»»æ„æ¥å£

  MapStruct = ç¼–è¯‘æ—¶ ğŸ”¨
  - Maven/Gradleç¼–è¯‘æ—¶ç”ŸæˆJavaæºç 
  - ç›´æ¥æ–¹æ³•è°ƒç”¨ï¼Œæ€§èƒ½æ¥è¿‘æ‰‹å†™
  - ç±»å‹å®‰å…¨ï¼Œé”™è¯¯ç¼–è¯‘æ—¶å‘ç°

  è¿™å°±æ˜¯ä¸ºä»€ä¹ˆMapStructæ¯”åŸºäºåå°„çš„BeanUtilsæ€§èƒ½å¥½é‚£ä¹ˆå¤šçš„æ ¹æœ¬åŸå› ï¼

> æˆ‘æƒ³é—®ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯javaçš„ç±»åˆ°è¿è¡Œï¼Œåˆ°åº•ç»å†äº†å¤šå°‘ä¸ªè¿‡ç¨‹ï¼Œåˆæœ‰å“ªäº›è¿‡ç¨‹æ˜¯å¯ä»¥å¯¹ä»£ç è¿›è¡Œæ“ä½œçš„ï¼Œä¾‹å¦‚åœ¨ç”Ÿæˆçš„å­—èŠ‚ç å‰åæ·»åŠ 
  é€»è¾‘ç­‰

âœ» Thinkingâ€¦

  ç”¨æˆ·é—®çš„æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼Œå…³äºJavaä»æºç åˆ°è¿è¡Œçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠåœ¨å“ªäº›é˜¶æ®µå¯ä»¥è¿›è¡Œä»£ç æ“ä½œ/å¢å¼ºã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ·±å…¥çš„Java
  æŠ€æœ¯é—®é¢˜ï¼Œéœ€è¦ç³»ç»Ÿæ€§åœ°å›ç­”ã€‚

  è®©æˆ‘ç»„ç»‡ä¸€ä¸‹æ€è·¯ï¼š

  1. Javaç¨‹åºçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
  2. æ¯ä¸ªé˜¶æ®µå¯ä»¥è¿›è¡Œçš„ä»£ç æ“ä½œ/å¢å¼º
  3. å…·ä½“çš„æŠ€æœ¯å’Œå·¥å…·
  4. å®é™…åº”ç”¨åœºæ™¯

  æˆ‘éœ€è¦ç”¨æ¸…æ™°çš„å›¾è¡¨å’Œä¾‹å­æ¥è¯´æ˜è¿™ä¸ªè¿‡ç¨‹ã€‚

â— è¿™æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†è§£é‡ŠJavaä»£ç ä»ç¼–å†™åˆ°è¿è¡Œçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠæ¯ä¸ªé˜¶æ®µå¯ä»¥è¿›è¡Œçš„ä»£ç æ“ä½œã€‚

âœ» Thinkingâ€¦

  ç”¨æˆ·çš„é—®é¢˜å¾ˆå¥½ï¼Œæˆ‘éœ€è¦ç³»ç»Ÿåœ°æ¢³ç†Javaä»£ç çš„ç”Ÿå‘½å‘¨æœŸã€‚è®©æˆ‘å…ˆåˆ—å‡ºå®Œæ•´çš„è¿‡ç¨‹ï¼š

  1. æºç ç¼–å†™é˜¶æ®µ (.java)
  2. ç¼–è¯‘å‰å¤„ç† (æ³¨è§£å¤„ç†å™¨)
  3. ç¼–è¯‘é˜¶æ®µ (.java â†’ .class)
  4. ç¼–è¯‘åå¤„ç† (å­—èŠ‚ç å¢å¼º)
  5. ç±»åŠ è½½é˜¶æ®µ (ClassLoader)
  6. è¿è¡Œæ—¶é˜¶æ®µ (JVMæ‰§è¡Œ)

  æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸åŒçš„ä»£ç æ“ä½œèƒ½åŠ›ï¼Œæˆ‘éœ€è¦è¯¦ç»†è¯´æ˜ã€‚

â— ğŸ”„ Javaä»£ç ç”Ÿå‘½å‘¨æœŸå…¨æ™¯å›¾

  ğŸ“ æºç é˜¶æ®µ     ğŸ”§ ç¼–è¯‘å‰       ğŸ“¦ ç¼–è¯‘é˜¶æ®µ      ğŸ”¬ ç¼–è¯‘å       ğŸš€ ç±»åŠ è½½       âš¡ è¿è¡Œæ—¶
     (.java)   â†’ (æ³¨è§£å¤„ç†å™¨)  â†’ (.class)    â†’ (å­—èŠ‚ç å¢å¼º)  â†’ (ClassLoader) â†’ (JVMæ‰§è¡Œ)
       â†“            â†“            â†“             â†“              â†“             â†“
    IDEç”Ÿæˆ      ä»£ç ç”Ÿæˆ       javacç¼–è¯‘     å­—èŠ‚ç æ“ä½œ     ç±»è£…è½½/éªŒè¯    åŠ¨æ€ä»£ç†/åå°„

âœ» Thinkingâ€¦

  ç°åœ¨æˆ‘éœ€è¦è¯¦ç»†è§£é‡Šæ¯ä¸ªé˜¶æ®µçš„ä»£ç æ“ä½œèƒ½åŠ›ã€‚è®©æˆ‘ä¸€ä¸ªä¸€ä¸ªé˜¶æ®µæ¥åˆ†æï¼š

  1. æºç é˜¶æ®µ - IDEå·¥å…·ã€ä»£ç ç”Ÿæˆ
  2. ç¼–è¯‘å‰ - æ³¨è§£å¤„ç†å™¨ (APT)
  3. ç¼–è¯‘é˜¶æ®µ - ç¼–è¯‘å™¨æ’ä»¶
  4. ç¼–è¯‘å - å­—èŠ‚ç æ“ä½œ (ASM, Javassistç­‰)
  5. ç±»åŠ è½½ - ClassLoader, Java Agent
  6. è¿è¡Œæ—¶ - åŠ¨æ€ä»£ç†, åå°„, JVM TIç­‰

  æˆ‘éœ€è¦æä¾›å…·ä½“çš„æŠ€æœ¯å’Œä»£ç ç¤ºä¾‹ã€‚

â— ğŸ“ 1. æºç é˜¶æ®µ (.javaæ–‡ä»¶)

  å¯è¿›è¡Œçš„æ“ä½œï¼š

  - ä»£ç ç”Ÿæˆ/æ¨¡æ¿
  - IDEæ’ä»¶å¢å¼º
  - ä»£ç åˆ†æ/æ£€æŸ¥

  æŠ€æœ¯ç¤ºä¾‹ï¼š

  // IDEæ¨¡æ¿ç”Ÿæˆä»£ç 
  // è¾“å…¥: pojo + Tab
  public class User {
      private String name;
      private Integer age;

      // IDEè‡ªåŠ¨ç”Ÿæˆgetter/setter/toStringç­‰
  }

  // ä»£ç ç”Ÿæˆå™¨ (å¦‚MyBatis Generator)
  // XMLé…ç½® â†’ è‡ªåŠ¨ç”ŸæˆDAOã€Entityã€Mapperç­‰æ–‡ä»¶

  ğŸ”§ 2. ç¼–è¯‘å‰é˜¶æ®µ (æ³¨è§£å¤„ç†å™¨ APT)

  å¯è¿›è¡Œçš„æ“ä½œï¼š

  - æ‰«ææ³¨è§£ç”Ÿæˆæ–°çš„Javaæºæ–‡ä»¶
  - ç¼–è¯‘æ—¶æ£€æŸ¥å’ŒéªŒè¯
  - å…ƒæ•°æ®æ”¶é›†

  æŠ€æœ¯ç¤ºä¾‹ï¼š

  // Lombok: @Dataæ³¨è§£ â†’ ç¼–è¯‘å‰ç”Ÿæˆgetter/setter
  @Data
  public class User {
      private String name;  // ç¼–è¯‘å‰ä¼šç”ŸæˆgetName()/setName()
  }

  // MapStruct: @Mapperæ³¨è§£ â†’ ç¼–è¯‘å‰ç”Ÿæˆè½¬æ¢å™¨å®ç°ç±»
  @Mapper
  public interface UserConverter {
      UserConverter INSTANCE = Mappers.getMapper(UserConverter.class);
      UserVO toVO(UserDO user);  // ç¼–è¯‘å‰ç”Ÿæˆå…·ä½“å®ç°
  }

  // è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨
  @SupportedAnnotationTypes("com.example.MyAnnotation")
  public class MyProcessor extends AbstractProcessor {
      @Override
      public boolean process(Set<? extends TypeElement> annotations,
                            RoundEnvironment roundEnv) {
          // æ‰«æ@MyAnnotationï¼Œç”Ÿæˆé¢å¤–çš„Javaæ–‡ä»¶
          return true;
      }
  }

  ğŸ“¦ 3. ç¼–è¯‘é˜¶æ®µ (.java â†’ .class)

  å¯è¿›è¡Œçš„æ“ä½œï¼š

  - ç¼–è¯‘å™¨æ’ä»¶
  - è¯­æ³•ç³–å¤„ç†
  - ç¼–è¯‘ä¼˜åŒ–

  æŠ€æœ¯ç¤ºä¾‹ï¼š

  // ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¤„ç†è¯­æ³•ç³–
  List<String> list = Arrays.asList("a", "b");  // æ³›å‹æ“¦é™¤
  for (String item : list) { }  // ç¼–è¯‘ä¸ºè¿­ä»£å™¨æ¨¡å¼
  String str = "Hello " + "World";  // ç¼–è¯‘ä¸ºStringBuilder

  // ç¼–è¯‘å™¨æ’ä»¶ (å¦‚Error Prone)
  // åœ¨javacç¼–è¯‘è¿‡ç¨‹ä¸­æ£€æŸ¥å¸¸è§é”™è¯¯æ¨¡å¼

  ğŸ”¬ 4. ç¼–è¯‘åé˜¶æ®µ (å­—èŠ‚ç å¢å¼º)

  å¯è¿›è¡Œçš„æ“ä½œï¼š

  - å­—èŠ‚ç ä¿®æ”¹/å¢å¼º
  - AOPç»‡å…¥
  - æ€§èƒ½ç›‘æ§æ³¨å…¥

  æŠ€æœ¯ç¤ºä¾‹ï¼š

  ASM å­—èŠ‚ç æ“ä½œï¼š

  // ä½¿ç”¨ASMåœ¨æ–¹æ³•å‰åæ·»åŠ é€»è¾‘
  public class MethodTimingVisitor extends ClassVisitor {
      @Override
      public MethodVisitor visitMethod(int access, String name, String descriptor,
                                     String signature, String[] exceptions) {
          MethodVisitor mv = super.visitMethod(access, name, descriptor, signature, exceptions);
          return new MethodVisitor(ASM9, mv) {
              @Override
              public void visitCode() {
                  // åœ¨æ–¹æ³•å¼€å§‹æ·»åŠ ï¼šlong start = System.currentTimeMillis();
                  mv.visitMethodInsn(INVOKESTATIC, "java/lang/System",
                                   "currentTimeMillis", "()J", false);
                  mv.visitVarInsn(LSTORE, 1);
                  super.visitCode();
              }

              @Override
              public void visitInsn(int opcode) {
                  if (opcode == ARETURN || opcode == RETURN) {
                      // åœ¨returnå‰æ·»åŠ ï¼šSystem.out.println("è€—æ—¶:" + (System.currentTimeMillis() - start));
                  }
                  super.visitInsn(opcode);
              }
          };
      }
  }

  AspectJ ç¼–è¯‘æ—¶ç»‡å…¥ï¼š

  @Aspect
  public class LoggingAspect {
      @Around("@annotation(Log)")
      public Object logExecutionTime(ProceedingJoinPoint joinPoint) throws Throwable {
          long start = System.currentTimeMillis();
          Object result = joinPoint.proceed();
          long duration = System.currentTimeMillis() - start;
          System.out.println("æ–¹æ³• " + joinPoint.getSignature() + " è€—æ—¶: " + duration + "ms");
          return result;
      }
  }

  // ä½¿ç”¨AspectJç¼–è¯‘å™¨ (ajc) åœ¨å­—èŠ‚ç ä¸­ç»‡å…¥åˆ‡é¢é€»è¾‘

  ğŸš€ 5. ç±»åŠ è½½é˜¶æ®µ (ClassLoader)

  å¯è¿›è¡Œçš„æ“ä½œï¼š

  - ç±»åŠ è½½æ‹¦æˆª
  - å­—èŠ‚ç åŠ¨æ€ä¿®æ”¹
  - ç±»çƒ­æ›¿æ¢

  æŠ€æœ¯ç¤ºä¾‹ï¼š

  Java Agent:

  // premainæ–¹å¼ - JVMå¯åŠ¨æ—¶åŠ è½½
  public class MyAgent {
      public static void premain(String agentArgs, Instrumentation inst) {
          inst.addTransformer(new ClassFileTransformer() {
              @Override
              public byte[] transform(ClassLoader loader, String className,
                                    Class<?> classBeingRedefined,
                                    ProtectionDomain protectionDomain,
                                    byte[] classfileBuffer) {
                  if (className.equals("com/example/MyClass")) {
                      // åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç 
                      return enhanceClass(classfileBuffer);
                  }
                  return null;
              }
          });
      }
  }

  // å¯åŠ¨å‚æ•°ï¼šjava -javaagent:myagent.jar MyApp

  è‡ªå®šä¹‰ClassLoader:

  public class CustomClassLoader extends ClassLoader {
      @Override
      protected Class<?> findClass(String name) throws ClassNotFoundException {
          byte[] classData = loadClassData(name);
          // å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹å­—èŠ‚ç 
          byte[] enhancedData = enhanceClass(classData);
          return defineClass(name, enhancedData, 0, enhancedData.length);
      }
  }

  âš¡ 6. è¿è¡Œæ—¶é˜¶æ®µ (JVMæ‰§è¡Œ)

  å¯è¿›è¡Œçš„æ“ä½œï¼š

  - åŠ¨æ€ä»£ç†
  - åå°„æ“ä½œ
  - çƒ­éƒ¨ç½²
  - æ€§èƒ½ç›‘æ§

  æŠ€æœ¯ç¤ºä¾‹ï¼š

  JDKåŠ¨æ€ä»£ç†:

  // è¿è¡Œæ—¶åˆ›å»ºä»£ç†ç±»
  UserService proxy = (UserService) Proxy.newProxyInstance(
      UserService.class.getClassLoader(),
      new Class[]{UserService.class},
      (proxy1, method, args) -> {
          System.out.println("è°ƒç”¨æ–¹æ³•å‰: " + method.getName());
          Object result = method.invoke(target, args);
          System.out.println("è°ƒç”¨æ–¹æ³•å: " + method.getName());
          return result;
      }
  );

  CGLIBåŠ¨æ€ä»£ç†:

  // è¿è¡Œæ—¶ç”Ÿæˆå­ç±»
  Enhancer enhancer = new Enhancer();
  enhancer.setSuperclass(UserService.class);
  enhancer.setCallback(new MethodInterceptor() {
      @Override
      public Object intercept(Object obj, Method method, Object[] args,
                            MethodProxy proxy) throws Throwable {
          System.out.println("CGLIBæ‹¦æˆª: " + method.getName());
          return proxy.invokeSuper(obj, args);
      }
  });
  UserService proxy = (UserService) enhancer.create();

âœ» Thinkingâ€¦

  ç°åœ¨æˆ‘éœ€è¦æä¾›æ›´å¤šå®é™…çš„æŠ€æœ¯å’Œå·¥å…·ç¤ºä¾‹ï¼Œä»¥åŠå¯¹æ¯”åˆ†æè¿™äº›æŠ€æœ¯ã€‚è®©æˆ‘æ•´ç†ä¸€ä¸ªå®Œæ•´çš„æŠ€æœ¯å¯¹æ¯”è¡¨å’Œå®é™…åº”ç”¨åœºæ™¯ã€‚

â— ğŸ› ï¸ å„é˜¶æ®µä¸»è¦æŠ€æœ¯å’Œå·¥å…·å¯¹æ¯”

  | é˜¶æ®µ   | ä¸»è¦æŠ€æœ¯                   | å…¸å‹åº”ç”¨              | æ€§èƒ½å½±å“ | å¤æ‚åº¦ |
  |------|------------------------|-------------------|------|-----|
  | æºç é˜¶æ®µ | IDEæ’ä»¶ã€ä»£ç ç”Ÿæˆå™¨            | MyBatis Generator | æ—     | ä½   |
  | ç¼–è¯‘å‰  | APTã€Lombokã€MapStruct   | @Dataã€@Mapper     | æ—     | ä¸­   |
  | ç¼–è¯‘å  | ASMã€Javassistã€AspectJ  | AOPç»‡å…¥             | æ—     | é«˜   |
  | ç±»åŠ è½½  | Java Agentã€ClassLoader | ç›‘æ§ã€çƒ­éƒ¨ç½²            | ä½    | é«˜   |
  | è¿è¡Œæ—¶  | åŠ¨æ€ä»£ç†ã€åå°„                | Spring AOP        | ä¸­    | ä¸­   |

  ğŸ¯ å®é™…åº”ç”¨åœºæ™¯ä¸¾ä¾‹

  Springæ¡†æ¶çš„å¤šé˜¶æ®µå¢å¼ºï¼š

  // 1. ç¼–è¯‘å‰ï¼š@Autowiredç­‰æ³¨è§£ (ç¼–è¯‘æ—¶ä¸å¤„ç†ï¼Œè¿è¡Œæ—¶å¤„ç†)
  @Service
  public class UserService {
      @Autowired
      private UserRepository userRepository;  // è¿è¡Œæ—¶æ³¨å…¥

      // 2. ç¼–è¯‘å/è¿è¡Œæ—¶ï¼š@Transactional AOPå¢å¼º
      @Transactional
      public void saveUser(User user) {
          userRepository.save(user);
      }
  }

  // Springå¯åŠ¨æ—¶çš„å¤„ç†æµç¨‹ï¼š
  // 1. æ‰«æ@Serviceæ³¨è§£ (è¿è¡Œæ—¶åå°„)
  // 2. åˆ›å»º@Transactionalçš„ä»£ç†å¯¹è±¡ (è¿è¡Œæ—¶åŠ¨æ€ä»£ç†)
  // 3. å¤„ç†@Autowiredä¾èµ–æ³¨å…¥ (è¿è¡Œæ—¶åå°„)

  æ€§èƒ½ç›‘æ§çš„å¤šé˜¶æ®µå®ç°ï¼š

  // æ–¹æ¡ˆ1ï¼šç¼–è¯‘æ—¶APTæ³¨è§£å¤„ç†å™¨
  @PerformanceMonitor
  public class OrderService {
      public void processOrder() { } // ç¼–è¯‘æ—¶ç”Ÿæˆç›‘æ§ä»£ç 
  }

  // æ–¹æ¡ˆ2ï¼šç¼–è¯‘åå­—èŠ‚ç å¢å¼º (å¦‚SkyWalking)
  // æ— éœ€ä¿®æ”¹æºç ï¼Œè‡ªåŠ¨åœ¨æ–¹æ³•å‰åæ·»åŠ ç›‘æ§é€»è¾‘

  // æ–¹æ¡ˆ3ï¼šè¿è¡Œæ—¶åŠ¨æ€ä»£ç† (å¦‚Spring AOP)
  @Component
  @Aspect
  public class PerformanceAspect {
      @Around("@annotation(PerformanceMonitor)")
      public Object monitor(ProceedingJoinPoint joinPoint) { }
  }

âœ» Thinkingâ€¦

  ç°åœ¨æˆ‘éœ€è¦æ€»ç»“å›ç­”ç”¨æˆ·çš„æ ¸å¿ƒé—®é¢˜ï¼Œæ•´ç†ä¸€ä¸ªæ¸…æ™°çš„æ€»ç»“ã€‚ç”¨æˆ·ä¸»è¦æƒ³äº†è§£ï¼š
  1. Javaç±»åˆ°è¿è¡Œç»å†äº†å“ªäº›è¿‡ç¨‹
  2. å“ªäº›è¿‡ç¨‹å¯ä»¥å¯¹ä»£ç è¿›è¡Œæ“ä½œ
  3. å¦‚ä½•åœ¨ç”Ÿæˆå­—èŠ‚ç å‰åæ·»åŠ é€»è¾‘

  æˆ‘å·²ç»è¯¦ç»†è§£é‡Šäº†å„ä¸ªé˜¶æ®µï¼Œç°åœ¨éœ€è¦ä¸€ä¸ªæ¸…æ™°çš„æ€»ç»“ã€‚

â— ğŸ”¥ æ ¸å¿ƒå­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ·±å…¥

  ç¼–è¯‘åå­—èŠ‚ç æ“ä½œ - ASMå®æˆ˜ï¼š

  // åŸå§‹ä»£ç 
  public class Calculator {
      public int add(int a, int b) {
          return a + b;
      }
  }

  // ASMå¢å¼ºï¼šåœ¨æ–¹æ³•å‰åæ·»åŠ æ—¥å¿—
  public class CalculatorEnhancer {
      public static void main(String[] args) throws Exception {
          ClassReader cr = new ClassReader("Calculator");
          ClassWriter cw = new ClassWriter(cr, ClassWriter.COMPUTE_MAXS);
          ClassVisitor cv = new ClassVisitor(ASM9, cw) {
              @Override
              public MethodVisitor visitMethod(int access, String name, String descriptor,
                                             String signature, String[] exceptions) {
                  MethodVisitor mv = super.visitMethod(access, name, descriptor, signature, exceptions);
                  if ("add".equals(name)) {
                      return new MethodVisitor(ASM9, mv) {
                          @Override
                          public void visitCode() {
                              super.visitCode();
                              // æ·»åŠ ï¼šSystem.out.println("æ–¹æ³•å¼€å§‹æ‰§è¡Œ");
                              mv.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
                              mv.visitLdcInsn("æ–¹æ³•å¼€å§‹æ‰§è¡Œ");
                              mv.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println",
  "(Ljava/lang/String;)V", false);
                          }

                          @Override
                          public void visitInsn(int opcode) {
                              if (opcode == IRETURN) {
                                  // åœ¨returnå‰æ·»åŠ ï¼šSystem.out.println("æ–¹æ³•æ‰§è¡Œç»“æŸ");
                                  mv.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
                                  mv.visitLdcInsn("æ–¹æ³•æ‰§è¡Œç»“æŸ");
                                  mv.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println",
  "(Ljava/lang/String;)V", false);
                              }
                              super.visitInsn(opcode);
                          }
                      };
                  }
                  return mv;
              }
          };
          cr.accept(cv, 0);

          // ç”Ÿæˆå¢å¼ºåçš„å­—èŠ‚ç 
          byte[] enhancedCode = cw.toByteArray();
          Files.write(Paths.get("Calculator.class"), enhancedCode);
      }
  }

  Java Agent è¿è¡Œæ—¶å¢å¼ºï¼š

  // Agentå…¥å£
  public class TimingAgent {
      public static void premain(String agentArgs, Instrumentation inst) {
          inst.addTransformer(new TimingTransformer());
      }
  }

  // å­—èŠ‚ç è½¬æ¢å™¨
  public class TimingTransformer implements ClassFileTransformer {
      @Override
      public byte[] transform(ClassLoader loader, String className,
                            Class<?> classBeingRedefined, ProtectionDomain protectionDomain,
                            byte[] classfileBuffer) throws IllegalClassFormatException {

          if (className.startsWith("com/mycompany")) {  // åªå¢å¼ºç‰¹å®šåŒ…
              return addTimingCode(classfileBuffer);
          }
          return null;
      }

      private byte[] addTimingCode(byte[] originalCode) {
          // ä½¿ç”¨ASMåœ¨æ¯ä¸ªæ–¹æ³•å‰åæ·»åŠ è®¡æ—¶é€»è¾‘
          ClassReader cr = new ClassReader(originalCode);
          ClassWriter cw = new ClassWriter(cr, ClassWriter.COMPUTE_MAXS);
          // ... ASMä»£ç å¢å¼ºé€»è¾‘
          return cw.toByteArray();
      }
  }

  // ä½¿ç”¨æ–¹å¼ï¼šjava -javaagent:timing-agent.jar MyApp

  ğŸ“Š æ€§èƒ½å¯¹æ¯” & é€‰æ‹©æŒ‡å—

  æ€§èƒ½å½±å“æ’åºï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š

  1. ç¼–è¯‘å‰ (APT) - æ— è¿è¡Œæ—¶å½±å“ â­â­â­â­â­
  2. ç¼–è¯‘å (ASM) - æ— è¿è¡Œæ—¶å½±å“ â­â­â­â­â­
  3. ç±»åŠ è½½ (Agent) - è½»å¾®å¯åŠ¨å½±å“ â­â­â­â­
  4. è¿è¡Œæ—¶ (åŠ¨æ€ä»£ç†) - æ¯æ¬¡è°ƒç”¨éƒ½æœ‰å¼€é”€ â­â­â­

  æŠ€æœ¯é€‰æ‹©å»ºè®®ï¼š

  // åœºæ™¯1ï¼šå¯¹è±¡è½¬æ¢ â†’ é€‰æ‹©ç¼–è¯‘å‰APT
  @Mapper  // MapStruct - ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œè¿è¡Œæ—¶é›¶å¼€é”€
  public interface UserConverter { }

  // åœºæ™¯2ï¼šå…¨å±€ç›‘æ§ â†’ é€‰æ‹©Java Agent
  // SkyWalking, Pinpointç­‰APMå·¥å…·

  // åœºæ™¯3ï¼šä¸šåŠ¡AOP â†’ é€‰æ‹©è¿è¡Œæ—¶ä»£ç†
  @Transactional  // Spring - è¿è¡Œæ—¶åŠ¨æ€ä»£ç†
  public void businessMethod() { }

  // åœºæ™¯4ï¼šæ€§èƒ½å…³é”®åœºæ™¯ â†’ é€‰æ‹©ç¼–è¯‘åå­—èŠ‚ç å¢å¼º
  // ç›´æ¥ä¿®æ”¹.classæ–‡ä»¶ï¼Œæ— è¿è¡Œæ—¶å¼€é”€

  ğŸ’¡ æ€»ç»“å›ç­”

  Javaä»£ç ç”Ÿå‘½å‘¨æœŸçš„6ä¸ªå…³é”®é˜¶æ®µï¼š

  1. ğŸ“ æºç é˜¶æ®µ - IDEå·¥å…·ã€ä»£ç ç”Ÿæˆ
  2. ğŸ”§ ç¼–è¯‘å‰ - æ³¨è§£å¤„ç†å™¨ (APT)ï¼Œå¦‚Lombokã€MapStruct
  3. ğŸ“¦ ç¼–è¯‘é˜¶æ®µ - javacç¼–è¯‘ï¼Œè¯­æ³•ç³–å¤„ç†
  4. ğŸ”¬ ç¼–è¯‘å - å­—èŠ‚ç å¢å¼º (ASMã€Javassistã€AspectJ)
  5. ğŸš€ ç±»åŠ è½½ - Java Agentã€è‡ªå®šä¹‰ClassLoader
  6. âš¡ è¿è¡Œæ—¶ - åŠ¨æ€ä»£ç†ã€åå°„æ“ä½œ

  å¯ä»¥"æ·»åŠ é€»è¾‘"çš„æ ¸å¿ƒé˜¶æ®µï¼š

  - ç¼–è¯‘å‰ï¼šç”Ÿæˆé¢å¤–æºç  (MapStructç”Ÿæˆè½¬æ¢å™¨)
  - ç¼–è¯‘åï¼šä¿®æ”¹å­—èŠ‚ç  (ASMæ·»åŠ ç›‘æ§é€»è¾‘)
  - ç±»åŠ è½½ï¼šåŠ¨æ€è½¬æ¢å­—èŠ‚ç  (Java Agentæ‹¦æˆª)
  - è¿è¡Œæ—¶ï¼šä»£ç†æ‹¦æˆªæ–¹æ³•è°ƒç”¨ (Spring AOP)

  æœ€ä½³å®è·µï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„é˜¶æ®µè¿›è¡Œå¢å¼ºï¼Œä¼˜å…ˆé€‰æ‹©ç¼–è¯‘æ—¶æ–¹æ¡ˆä»¥è·å¾—æœ€ä½³æ€§èƒ½ï¼
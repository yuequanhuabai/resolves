 AuthConvert æ˜¯è®¤è¯æˆæƒæ¨¡å—çš„ä¸“ä¸šæ•°æ®è½¬æ¢å™¨ï¼Œè´Ÿè´£å°†åº•å±‚æ•°æ®å¯¹è±¡è½¬æ¢ä¸ºå‰ç«¯å‹å¥½çš„æƒé™ä¿¡æ¯ç»“æ„ã€‚

  ---
   è§’è‰²å®šä½

  è®¤è¯æˆæƒæ•°æ®çš„é€‚é…å™¨å’Œæ•´åˆå™¨ï¼Œæ‰¿æ‹…å¤æ‚æƒé™æ•°æ®çš„ç»“æ„åŒ–è½¬æ¢ï¼Œç‰¹åˆ«æ˜¯å°†æ‰å¹³åŒ–çš„æƒé™æ•°æ®è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„å±‚æ¬¡åŒ–ç»“æ„ã€‚

  ---
   æ ¸å¿ƒåŠŸèƒ½åˆ†æ

  1.  ç™»å½•ä»¤ç‰Œè½¬æ¢

  AuthLoginRespVO convert(OAuth2AccessTokenDO bean);

  // åŠŸèƒ½ï¼šå°†OAuth2è®¿é—®ä»¤ç‰Œè½¬æ¢ä¸ºç™»å½•å“åº”å¯¹è±¡
  // ç”¨é€”ï¼šç™»å½•æˆåŠŸåè¿”å›ç»™å‰ç«¯çš„ä»¤ç‰Œä¿¡æ¯

  2.  æƒé™ä¿¡æ¯æ•´åˆ (æ ¸å¿ƒåŠŸèƒ½)

  default AuthPermissionInfoRespVO convert(AdminUserDO user,
                                          List<RoleDO> roleList,
                                          List<MenuDO> menuList) {
      return AuthPermissionInfoRespVO.builder()
          .user(BeanUtils.toBean(user, AuthPermissionInfoRespVO.UserVO.class))
          .roles(convertSet(roleList, RoleDO::getCode))           // è§’è‰²ç¼–ç é›†åˆ
          .permissions(convertSet(menuList, MenuDO::getPermission)) // æƒé™æ ‡è¯†é›†åˆ
          .menus(buildMenuTree(menuList))                         // èœå•æ ‘ç»“æ„
          .build();
  }

  è¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªç³»ç»Ÿæƒé™æ§åˆ¶çš„æ ¸å¿ƒæ•°æ®æ•´åˆç‚¹ï¼Œå°†ä¸‰ç§ä¸åŒçš„æ•°æ®å¯¹è±¡æ•´åˆä¸ºå‰ç«¯å¯ç›´æ¥ä½¿ç”¨çš„æƒé™ä¿¡æ¯ã€‚

  3.  èœå•æ ‘æ„å»º (æŠ€æœ¯äº®ç‚¹)

  default List<AuthPermissionInfoRespVO.MenuVO> buildMenuTree(List<MenuDO> menuList)

  è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„æ ‘å½¢ç»“æ„æ„å»ºç®—æ³•ï¼Œè®©æˆ‘ä»¬è¯¦ç»†åˆ†æï¼š

  æ ‘æ„å»ºç®—æ³•æµç¨‹ï¼š

  æ­¥éª¤1: æ•°æ®é¢„å¤„ç†
  menuList.removeIf(menu -> menu.getType().equals(MenuTypeEnum.BUTTON.getType()));
  // è¿‡æ»¤æ‰æŒ‰é’®ç±»å‹ï¼Œåªä¿ç•™èœå•å’Œç›®å½•

  æ­¥éª¤2: æ’åºä¿è¯æœ‰åºæ€§
  menuList.sort(Comparator.comparing(MenuDO::getSort));
  // æŒ‰sortå­—æ®µæ’åºï¼Œç¡®ä¿èœå•æ˜¾ç¤ºé¡ºåºæ­£ç¡®

  æ­¥éª¤3: æ‰å¹³æ•°æ®æ˜ å°„
  Map<Long, AuthPermissionInfoRespVO.MenuVO> treeNodeMap = new LinkedHashMap<>();
  menuList.forEach(menu -> treeNodeMap.put(menu.getId(), convertTreeNode(menu)));
  // å°†æ‰€æœ‰èœå•è½¬æ¢ä¸ºVOå¯¹è±¡ï¼Œå­˜å‚¨åœ¨Mapä¸­ä¾¿äºæŸ¥æ‰¾

  æ­¥éª¤4: æ„å»ºçˆ¶å­å…³ç³»
  treeNodeMap.values().stream()
      .filter(node -> !node.getParentId().equals(ID_ROOT))  // è¿‡æ»¤éæ ¹èŠ‚ç‚¹
      .forEach(childNode -> {
          AuthPermissionInfoRespVO.MenuVO parentNode = treeNodeMap.get(childNode.getParentId());
          // å°†å­èŠ‚ç‚¹æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„childrenåˆ—è¡¨ä¸­
          parentNode.getChildren().add(childNode);
      });

  æ­¥éª¤5: è¿”å›æ ¹èŠ‚ç‚¹åˆ—è¡¨
  return filterList(treeNodeMap.values(), node -> ID_ROOT.equals(node.getParentId()));
  // åªè¿”å›æ ¹èŠ‚ç‚¹ï¼Œå­èŠ‚ç‚¹é€šè¿‡childrenå±æ€§è®¿é—®

  ---
  ğŸ”§ æŠ€æœ¯è®¾è®¡ç‰¹ç‚¹

  MapStruct + è‡ªå®šä¹‰é€»è¾‘æ··åˆæ¨¡å¼

  @Mapper
  public interface AuthConvert {
      AuthConvert INSTANCE = Mappers.getMapper(AuthConvert.class);

      // MapStructè‡ªåŠ¨ç”Ÿæˆçš„ç®€å•è½¬æ¢
      AuthLoginRespVO convert(OAuth2AccessTokenDO bean);
      AuthPermissionInfoRespVO.MenuVO convertTreeNode(MenuDO menu);

      // æ‰‹å·¥å®ç°çš„å¤æ‚è½¬æ¢é€»è¾‘
      default AuthPermissionInfoRespVO convert(AdminUserDO user, List<RoleDO> roleList, List<MenuDO> menuList)
      default List<AuthPermissionInfoRespVO.MenuVO> buildMenuTree(List<MenuDO> menuList)
  }

  æ€§èƒ½ä¼˜åŒ–è®¾è®¡

  // ä½¿ç”¨LinkedHashMapä¿è¯é¡ºåºæ€§å’ŒæŸ¥æ‰¾æ•ˆç‡
  Map<Long, AuthPermissionInfoRespVO.MenuVO> treeNodeMap = new LinkedHashMap<>();

  // ä¸€æ¬¡éå†æ„å»ºæ ‘å½¢ç»“æ„ï¼Œæ—¶é—´å¤æ‚åº¦O(n)
  // ç›¸æ¯”é€’å½’æ„å»ºæ ‘çš„O(nÂ²)å¤æ‚åº¦ï¼Œæ€§èƒ½æ›´ä¼˜

  é”™è¯¯å¤„ç†æœºåˆ¶

  if (parentNode == null) {
      LoggerFactory.getLogger(getClass()).error("[buildRouterTree][resource({}) æ‰¾ä¸åˆ°çˆ¶èµ„æº({})]",
              childNode.getId(), childNode.getParentId());
      return;  // ä¼˜é›…å¤„ç†æ•°æ®ä¸ä¸€è‡´æƒ…å†µ
  }

  ---
   æ•°æ®è½¬æ¢é“¾è·¯

  æƒé™ä¿¡æ¯è½¬æ¢æµç¨‹

  // è¾“å…¥ï¼šä¸‰ç§æ•°æ®åº“å®ä½“å¯¹è±¡
  AdminUserDO user      // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  List<RoleDO> roleList // ç”¨æˆ·è§’è‰²åˆ—è¡¨
  List<MenuDO> menuList // ç”¨æˆ·å¯è®¿é—®èœå•åˆ—è¡¨

          â†“ AuthConvert.convert()

  // è¾“å‡ºï¼šå‰ç«¯æƒé™ä¿¡æ¯å¯¹è±¡
  AuthPermissionInfoRespVO {
      user: UserVO,              // ç”¨æˆ·ä¿¡æ¯VO
      roles: Set<String>,        // è§’è‰²ç¼–ç é›†åˆ ["admin", "user"]
      permissions: Set<String>,  // æƒé™æ ‡è¯†é›†åˆ ["user:create", "user:update"]
      menus: List<MenuVO>        // å±‚æ¬¡åŒ–èœå•æ ‘
  }

  èœå•æ ‘è½¬æ¢ç¤ºä¾‹

  // è¾“å…¥ï¼šæ‰å¹³åŒ–èœå•æ•°æ®
  [
    {id: 1, name: "ç³»ç»Ÿç®¡ç†", parentId: 0, sort: 1},
    {id: 2, name: "ç”¨æˆ·ç®¡ç†", parentId: 1, sort: 1},
    {id: 3, name: "è§’è‰²ç®¡ç†", parentId: 1, sort: 2},
    {id: 4, name: "æƒé™ç®¡ç†", parentId: 0, sort: 2}
  ]

          â†“ buildMenuTree()

  // è¾“å‡ºï¼šå±‚æ¬¡åŒ–èœå•æ ‘
  [
    {
      id: 1, name: "ç³»ç»Ÿç®¡ç†", parentId: 0,
      children: [
        {id: 2, name: "ç”¨æˆ·ç®¡ç†", parentId: 1, children: []},
        {id: 3, name: "è§’è‰²ç®¡ç†", parentId: 1, children: []}
      ]
    },
    {
      id: 4, name: "æƒé™ç®¡ç†", parentId: 0, children: []
    }
  ]
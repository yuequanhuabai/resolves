éªŒè¯ç”¨æˆ·è¿™ä¸ªæˆ‘å¯ä»¥ç†è§£ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ˜¯ä¸ªè¦å¦‚ä½•éªŒè¯å‘¢ï¼Ÿ
  æˆ‘ä½¿ç”¨çš„åœºæ™¯ä¸€èˆ¬å®¢æˆ·ç«¯æ˜¯æµè§ˆå™¨ï¼Œç±»ä¼¼chromeæµè§ˆå™¨ï¼Œæˆ‘æƒ³çŸ¥é“æˆæƒæœåŠ¡å…¶å¦‚ä½•éªŒè¯chromeæµè§ˆå™¨çš„è¿™ç§å®¢æˆ·ç«¯æŠ½è±¡å‘¢ï¼Ÿ

âœ» Thinkingâ€¦

  è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼ç”¨æˆ·å¯¹OAuth2ä¸­"å®¢æˆ·ç«¯"çš„æ¦‚å¿µæœ‰äº›è¯¯è§£ã€‚ä»–ä»¬è®¤ä¸ºå®¢æˆ·ç«¯å°±æ˜¯æµè§ˆå™¨ï¼ˆæ¯”å¦‚Chromeï¼‰ï¼Œä½†å®é™…ä¸Šåœ¨OAuth2ä¸­
  ï¼Œå®¢æˆ·ç«¯å¹¶ä¸æ˜¯æµè§ˆå™¨æœ¬èº«ï¼Œè€Œæ˜¯è¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„åº”ç”¨ç¨‹åºã€‚

  è®©æˆ‘æ¥æ¾„æ¸…è¿™ä¸ªæ¦‚å¿µï¼š

  1. æµè§ˆå™¨ä¸æ˜¯OAuth2ä¸­çš„å®¢æˆ·ç«¯
  2. è¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„åº”ç”¨ç¨‹åºï¼ˆæ¯”å¦‚Reactåº”ç”¨ã€Vueåº”ç”¨ç­‰ï¼‰æ‰æ˜¯å®¢æˆ·ç«¯
  3. å¯¹äºä¸åŒç±»å‹çš„å®¢æˆ·ç«¯ï¼ŒéªŒè¯æ–¹å¼æ˜¯ä¸åŒçš„

  æˆ‘éœ€è¦è¯¦ç»†è§£é‡Šï¼š
  - ä»€ä¹ˆæ˜¯OAuth2ä¸­çš„å®¢æˆ·ç«¯
  - ä¸åŒç±»å‹å®¢æˆ·ç«¯çš„éªŒè¯æ–¹å¼
  - ä¸ºä»€ä¹ˆæµè§ˆå™¨ä¸æ˜¯å®¢æˆ·ç«¯
  - SPAï¼ˆå•é¡µåº”ç”¨ï¼‰å¦‚ä½•è¿›è¡Œå®¢æˆ·ç«¯éªŒè¯
  - å…¬å¼€å®¢æˆ·ç«¯vsæœºå¯†å®¢æˆ·ç«¯çš„åŒºåˆ«

â— è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µæ¾„æ¸…ï¼ä½ çš„ç†è§£æœ‰ä¸€ä¸ªå…³é”®è¯¯åŒºï¼š

  ğŸš¨ é‡è¦æ¦‚å¿µæ¾„æ¸…

  Chromeæµè§ˆå™¨ä¸æ˜¯OAuth2ä¸­çš„"å®¢æˆ·ç«¯"ï¼

  OAuth2ä¸­çš„"å®¢æˆ·ç«¯"æ˜¯æŒ‡è¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„åº”ç”¨ç¨‹åºï¼Œä¸æ˜¯æµè§ˆå™¨æœ¬èº«ã€‚

  ğŸ¯ ä»€ä¹ˆæ˜¯OAuth2ä¸­çš„"å®¢æˆ·ç«¯"ï¼Ÿ

  å®¢æˆ·ç«¯ = åº”ç”¨ç¨‹åºï¼Œä¸æ˜¯æµè§ˆå™¨

  âŒ é”™è¯¯ç†è§£ï¼š
  å®¢æˆ·ç«¯ = Chromeæµè§ˆå™¨

  âœ… æ­£ç¡®ç†è§£ï¼š
  å®¢æˆ·ç«¯ = è¿è¡Œåœ¨Chromeä¸­çš„Reactåº”ç”¨
  å®¢æˆ·ç«¯ = è¿è¡Œåœ¨Chromeä¸­çš„Vueåº”ç”¨
  å®¢æˆ·ç«¯ = è¿è¡Œåœ¨Chromeä¸­çš„Angularåº”ç”¨

  å…·ä½“ç¤ºä¾‹

  åœºæ™¯1ï¼šç”¨æˆ·åœ¨Chromeä¸­è®¿é—®GitHubç½‘ç«™
  - æµè§ˆå™¨ï¼šChromeï¼ˆåªæ˜¯è½½ä½“ï¼‰
  - OAuth2å®¢æˆ·ç«¯ï¼šGitHubçš„Webåº”ç”¨
  - å®¢æˆ·ç«¯IDï¼šgithub-web-client

  åœºæ™¯2ï¼šç”¨æˆ·åœ¨Chromeä¸­è®¿é—®ä½ çš„Reactåº”ç”¨
  - æµè§ˆå™¨ï¼šChromeï¼ˆåªæ˜¯è½½ä½“ï¼‰
  - OAuth2å®¢æˆ·ç«¯ï¼šä½ çš„Reactåº”ç”¨
  - å®¢æˆ·ç«¯IDï¼šreact-client

  ğŸ” å®¢æˆ·ç«¯ç±»å‹å’ŒéªŒè¯æ–¹å¼

  1. æœºå¯†å®¢æˆ·ç«¯ï¼ˆConfidential Clientï¼‰

  ç‰¹ç‚¹ï¼šèƒ½å¤Ÿå®‰å…¨å­˜å‚¨å®¢æˆ·ç«¯å¯†é’¥
  // æœåŠ¡ç«¯Webåº”ç”¨
  @Component
  public class WebAppClient {
      // å¯ä»¥å®‰å…¨å­˜å‚¨åœ¨æœåŠ¡å™¨é…ç½®ä¸­
      private String clientSecret = "very-secret-key-123";

      public void exchangeToken(String code) {
          // æœåŠ¡ç«¯åˆ°æœåŠ¡ç«¯çš„è¯·æ±‚ï¼Œå¯ä»¥å®‰å…¨ä¼ è¾“å¯†é’¥
          HttpHeaders headers = new HttpHeaders();
          headers.setBasicAuth(clientId, clientSecret);  // å®‰å…¨ï¼
      }
  }

  éªŒè¯æ–¹å¼ï¼šä½¿ç”¨client_secret
  POST /oauth2/token
  Authorization: Basic base64(client_id:client_secret)
  Body: grant_type=authorization_code&code=...

  2. å…¬å¼€å®¢æˆ·ç«¯ï¼ˆPublic Clientï¼‰

  ç‰¹ç‚¹ï¼šæ— æ³•å®‰å…¨å­˜å‚¨å®¢æˆ·ç«¯å¯†é’¥
  // å‰ç«¯Reactåº”ç”¨
  class ReactOAuth2Client {
      constructor() {
          this.clientId = 'react-client';
          // âŒ ä¸èƒ½å­˜å‚¨å¯†é’¥ï¼ä»»ä½•äººéƒ½èƒ½åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°
          // this.clientSecret = 'secret'; // è¿™æ ·åšæ˜¯å±é™©çš„ï¼
      }
  }

  éªŒè¯æ–¹å¼ï¼šä½¿ç”¨å…¶ä»–æ–¹æ³•
  - PKCEï¼ˆæ¨èï¼‰
  - é‡å®šå‘URIéªŒè¯
  - å®¢æˆ·ç«¯æ³¨å†Œä¿¡æ¯

  ğŸ›¡ï¸ å…¬å¼€å®¢æˆ·ç«¯çš„éªŒè¯æ–¹æ³•

  æ–¹æ³•1ï¼šPKCEéªŒè¯ï¼ˆæœ€å®‰å…¨ï¼‰

  // Reactåº”ç”¨ç”ŸæˆPKCEå‚æ•°
  class OAuth2Service {
      authorize() {
          // 1. ç”ŸæˆéšæœºéªŒè¯ç 

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚Â >Â                                                                                                                                                                                         â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  âµâµ accept edits on (shift+tab to cycle)
              `client_id=${this.clientId}&` +
              `code_challenge=${codeChallenge}&` +
              `code_challenge_method=S256&` +
              `...`;

          localStorage.setItem('code_verifier', codeVerifier);
          window.location.href = authUrl;
      }

      async handleCallback(code) {
          const codeVerifier = localStorage.getItem('code_verifier');

          // 3. ä»¤ç‰Œè¯·æ±‚åŒ…å«verifier
          const response = await fetch('/oauth2/token', {
              method: 'POST',
              body: new URLSearchParams({
                  grant_type: 'authorization_code',
                  client_id: this.clientId,
                  code: code,
                  code_verifier: codeVerifier  // éªŒè¯å®¢æˆ·ç«¯èº«ä»½
              })
          });
      }
  }

  PKCEéªŒè¯åŸç†ï¼š
  æˆæƒæœåŠ¡å™¨éªŒè¯é€»è¾‘ï¼š
  1. æ”¶åˆ°æˆæƒè¯·æ±‚æ—¶ï¼Œå­˜å‚¨ code_challenge
  2. æ”¶åˆ°ä»¤ç‰Œè¯·æ±‚æ—¶ï¼ŒéªŒè¯ï¼š
     SHA256(code_verifier) === stored_code_challenge
  3. åªæœ‰ç”Ÿæˆchallengeçš„å®¢æˆ·ç«¯æ‰æœ‰verifier
  4. å³ä½¿æˆæƒç è¢«æ‹¦æˆªï¼Œæ²¡æœ‰verifierä¹Ÿæ— æ³•æ¢å–ä»¤ç‰Œ

  æ–¹æ³•2ï¼šé‡å®šå‘URIéªŒè¯

  // æˆæƒæœåŠ¡å™¨éªŒè¯é‡å®šå‘URI
  @Service
  public class ClientValidationService {

      public boolean validateClient(String clientId, String redirectUri) {
          RegisteredClient client = clientRepository.findByClientId(clientId);

          // éªŒè¯é‡å®šå‘URIæ˜¯å¦åœ¨æ³¨å†Œåˆ—è¡¨ä¸­
          return client.getRedirectUris().contains(redirectUri);
      }
  }

  éªŒè¯é€»è¾‘ï¼š
  æ³¨å†Œæ—¶ï¼šreact-client åªèƒ½é‡å®šå‘åˆ° http://localhost:3000/*
  è¿è¡Œæ—¶ï¼šå¦‚æœæœ‰äººè¯•å›¾é‡å®šå‘åˆ° http://evil.comï¼ŒéªŒè¯å¤±è´¥ï¼

  æ–¹æ³•3ï¼šå®¢æˆ·ç«¯æ³¨å†ŒéªŒè¯

  // å®¢æˆ·ç«¯æ³¨å†Œä¿¡æ¯éªŒè¯
  @Bean
  public RegisteredClient reactClient() {
      return RegisteredClient.withId("react-client-id")
          .clientId("react-client")
          // æ³¨æ„ï¼šå…¬å¼€å®¢æˆ·ç«¯æ²¡æœ‰å¯†é’¥ï¼
          .clientAuthenticationMethod(ClientAuthenticationMethod.NONE)
          .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚Â >Â                                                                                                                                                                                         â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  âµâµ accept edits on (shift+tab to cycle)                                                                                                                                    Auto-updatingâ€¦
                                                                                                                                                                                               }

  ğŸ“Š éªŒè¯æ–¹å¼å¯¹æ¯”

  | å®¢æˆ·ç«¯ç±»å‹ | éªŒè¯æ–¹æ³•          | å®‰å…¨çº§åˆ« | é€‚ç”¨åœºæ™¯         |
  |-------|---------------|------|--------------|
  | æœºå¯†å®¢æˆ·ç«¯ | client_secret | ğŸ”’ é«˜ | æœåŠ¡ç«¯Webåº”ç”¨     |
  | å…¬å¼€å®¢æˆ·ç«¯ | PKCE          | ğŸ”’ é«˜ | SPAã€ç§»åŠ¨åº”ç”¨ï¼ˆæ¨èï¼‰ |
  | å…¬å¼€å®¢æˆ·ç«¯ | é‡å®šå‘URI        | ğŸ” ä¸­ | ç®€å•Webåº”ç”¨      |
  | å…¬å¼€å®¢æˆ·ç«¯ | æ— éªŒè¯           | âš ï¸ ä½ | ä»…å¼€å‘ç¯å¢ƒ        |

  ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹

  ä½ çš„Reactåº”ç”¨éªŒè¯æµç¨‹ï¼š

  // 1. Reactåº”ç”¨é…ç½®ï¼ˆå…¬å¼€å®¢æˆ·ç«¯ï¼‰
  const oauth2Config = {
      clientId: 'react-client',        // å…¬å¼€çš„æ ‡è¯†ç¬¦
      // æ³¨æ„ï¼šæ²¡æœ‰clientSecretï¼
      redirectUri: 'http://localhost:3000/oauth2/callback',
      codeChallenge: generatePKCE()    // PKCEéªŒè¯
  };

  // 2. æˆæƒè¯·æ±‚
  GET /oauth2/authorize?
      client_id=react-client&
      redirect_uri=http://localhost:3000/oauth2/callback&
      code_challenge=dBjftJeZ...&
      code_challenge_method=S256

  // 3. ä»¤ç‰Œè¯·æ±‚
  POST /oauth2/token
  Content-Type: application/x-www-form-urlencoded

  grant_type=authorization_code&
  client_id=react-client&              // å®¢æˆ·ç«¯æ ‡è¯†
  code=received_auth_code&
  redirect_uri=http://localhost:3000/oauth2/callback&
  code_verifier=dBjftJeZ...           // PKCEéªŒè¯ç 

  æˆæƒæœåŠ¡å™¨çš„éªŒè¯é€»è¾‘ï¼š

  @Component
  public class OAuth2TokenEndpoint {

      public ResponseEntity<?> token(TokenRequest request) {
          // 1. æ ¹æ®client_idæŸ¥æ‰¾å®¢æˆ·ç«¯é…ç½®
          RegisteredClient client = findClientById(request.getClientId());

          // 2. éªŒè¯å®¢æˆ·ç«¯ç±»å‹
          if (client.getClientAuthenticationMethod() == ClientAuthenticationMethod.NONE) {
              // å…¬å¼€å®¢æˆ·ç«¯ï¼Œä½¿ç”¨PKCEéªŒè¯
              if (!validatePKCE(request.getCodeVerifier(), storedChallenge)) {
                  return ResponseEntity.badRequest().body("PKCEéªŒè¯å¤±è´¥");
              }
          } else {
              // æœºå¯†å®¢æˆ·ç«¯ï¼Œä½¿ç”¨å¯†é’¥éªŒè¯
              if (!validateClientSecret(request.getClientSecret(), client.getSecret())) {
                  return ResponseEntity.badRequest().body("å®¢æˆ·ç«¯å¯†é’¥é”™è¯¯");
              }
          }

          // 3. éªŒè¯é‡å®šå‘URI
          if (!client.getRedirectUris().contains(request.getRedirectUri())) {
              return ResponseEntity.badRequest().body("æ— æ•ˆçš„é‡å®šå‘URI");
          }

          // 4. ç”Ÿæˆä»¤ç‰Œ
          return ResponseEntity.ok(generateTokens());
      }
  }

  ğŸ’¡ å…³é”®ç†è§£

  1. æµè§ˆå™¨ â‰  å®¢æˆ·ç«¯ï¼šæµè§ˆå™¨åªæ˜¯è¿è¡Œç¯å¢ƒï¼ŒReactåº”ç”¨æ‰æ˜¯OAuth2å®¢æˆ·ç«¯
  2. å…¬å¼€å®¢æˆ·ç«¯æ— å¯†é’¥ï¼šå‰ç«¯åº”ç”¨æ— æ³•å®‰å…¨å­˜å‚¨å¯†é’¥ï¼Œå¿…é¡»ä½¿ç”¨å…¶ä»–éªŒè¯æ–¹æ³•
  3. PKCEæ˜¯æœ€ä½³å®è·µï¼šä¸ºå…¬å¼€å®¢æˆ·ç«¯æä¾›äº†ä¸å¯†é’¥éªŒè¯ç›¸å½“çš„å®‰å…¨æ€§
  4. å¤šé‡éªŒè¯æœºåˆ¶ï¼šclientId + PKCE + redirectUri + æˆæƒç ï¼Œå¤šå±‚é˜²æŠ¤

  æ‰€ä»¥ï¼ŒæˆæƒæœåŠ¡å™¨éªŒè¯çš„ä¸æ˜¯Chromeæµè§ˆå™¨ï¼Œè€Œæ˜¯ä½ åœ¨Chromeä¸­è¿è¡Œçš„Reactåº”ç”¨ï¼